:scrollbar:
:toc2:
:numbered:
= ストレージ管理

== はじめに

Red Hat OpenShift は、オンプレミスとクラウドプロバイダーの両方で、複数のタイプのストレージをサポートしています。OpenShift Virtualization では、OpenShift を実行している環境で、さまざまなコンテナ・ストレージ・インターフェース (CSI) プロビジョナーを使用できます。例えば、OpenShift Data Foundation、NetApp、Dell/EMC、Fujitsu、Hitachi、Pure Storage、Portworx、その他多くの企業が、OpenShift Virtualization でオンプレミス、CSI プロビジョニング、ReadWriteMany (RWX) ボリュームをサポートしています。

このモジュールでは、ストレージプロバイダにストレージを要求し、VM ディスクを保存するために使用される Persistent Volume Claims (PVC) について探索します。多くのストレージプロバイダでは、ストレージデバイスのスナップショットやクローンもサポートしていますが、CSI ドライバやストレージでサポートされている機能については、必ずベンダに確認してください。

特筆すべきこととして、OpenShift Virtualization には特有のストレージプロトコル (NFS, iSCSI, FC, など) の制限はありません。唯一の要件は、Live Migration のために  RWX アクセスモードが利用できることです。その他については、VM とアプリケーションの要求を最も満たすストレージが常に正しい選択です。

image::module-02/00_disk_concepts.png[link=self, window=blank, width=100%]

[[examine_pvc]]

== 仮想マシンの PVC を確認

このセクションでは、先ほど作成した `fedora01` VM の背後にあるストレージを詳しく見ていきます。

. 左メニューで *Storage* -> *PersistentVolumeClaims* をクリックします。*vmexamples* プロジェクトにいることを確認し、`fedora01` PVC が表示されていることを確認してください。
+
//add image
+
. `fedora01` をクリックすると、VM のバックエンドにあるストレージボリュームの詳細が表示されます。
+
. この PVC には以下のような情報が表示されます。
.. ステータスは `Bound`（正常にバインドされている）
.. 要求された容量と割り当てられた容量は 30GiB
.. Access mode は *ReadWriteMany (RWX)*
.. Volume mode は *Block*
.. StorageClass は *ocs-storagecluster-ceph-rbd-virtualization*
+
image::module-02/02_Fedora01_PVC_Details.png[link=self, window=blank, width=100%]

[[managing_snapshots]]
== Managing Snapshots

OpenShift Virtualization relies on the CSI storage provider's snapshot capability to create disk snapshots for the virtual machine, which can be taken "online" while the VM is running or "offline" while the VM is powered off. If the KVM integrations are installed on the VM, you will also have the option of quiescing the guest operating system (quiescing ensures that the snapshot of the disk represents a consistent state of the guest file systems, e.g., buffers are flushed and the journal is consistent).

Since disk snapshots are dependent on the storage implementation, abstracted by the CSI, performance impact and capacity used will depend on the storage provider. Work with your storage vendor to determine how the system will manage PVC snapshots and the impact they may or may not have.

[IMPORTANT]
====
Snapshots, by themselves, are not a backup or disaster recovery capability. The data needs to be protected in other ways, such as one or more copies stored in a different location, to recover from the storage system failing.

In addition to the OpenShift API for Data Protection (OADP), partners such as Kasten by Veeam, Trilio, and Storware support the ability to backup and restore virtual machines to the same cluster or other clusters as needed.
====

With the VM snapshots feature, cluster administrators and application developers can:

* Create a new snapshot
* List all snapshots attached to a specific VM
* Revert a VM to a snapshot
* Delete an existing VM snapshot

=== Creating and Using Snapshots

. Navigate back to *Virtualization* -> *VirtualMachines* and select the virtual machine, *fedora01* in the project *vmexamples*.
+
image::module-02/03_VM_Overview.png[link=self, window=blank, width=100%]
+
. Notice there are currently no snapshots of this VM listed on the overview page. 
+
image::module-02/04_Snapshots_Overview.png[link=self, window=blank, width=100%]
+
. Navigate to the *Snapshots* tab.
+
image::module-02/05_Snapshot_Menu.png[link=self, window=blank, width=100%]

. Press *Take snapshot* and a dialog will open
+
[NOTE]
There is a warning about the *cloudinitdisk* not being included in the snapshot. This is expected and happens because it is an ephemeral disk.
+
image::module-02/06_VM_Snapshot_Dialog.png[link=self, window=blank, width=100%]

. Press *Save* and wait till the _Snapshot_ has been created and the *status* shows as *Succeeded*.
+
image::module-02/07_VM_Snapshot_Taken.png[link=self, window=blank, width=100%]

. Press the three-dot menu, and see that the *Restore* option is greyed out because the VM is currently running.
+
image::module-02/08_VM_Restore_Disabled.png[link=self, window=blank, width=100%]

. Next, switch to the *Console* tab. We are going to login and perform a modification that prevents the VM from being able to boot. 
+
image::module-02/09_Console_Login.png[link=self, window=blank, width=100%]
+
. Click on the *Guest login credentials* dropdown to gather the username and password to log into your console.
+
NOTE: There is a *Copy to clipboard* button and a *Paste* button available here, which makes the login process much easier.
+
. Once you are logged in, execute the following command: 
+
[source,sh,role=execute]
----
sudo rm -rf /boot/grub2; sudo shutdown -r now
----
+
. The virtual machine will no longer be able to boot. 
+
image::module-02/10_Bootloader_Broken.png[link=self, window=blank, width=100%]
+
IMPORTANT: In the previous step, the operating system was shutdown from within the guest. However, OpenShift Virtualization will restart it automatically by default. This behavior can be changed globally or on a per-VM basis.
+
. Using the *Actions* dropdown menu or the shortcut button in the top right corner, *Stop* the VM. This process can take a long time since it attempts a graceful shutdown and the machine is in an unstable state. If you click on the *Actions* dropdown menu again you will have the option to *Force stop*. Please make use of this option in order to continue with the lab. 
+
. You can click on the *Overview* tab to confirm that the VM has stopped. You can also see the snapshot we recently took listed in the *Snapshots* tile. (You may need to Force Stop the VM via the dropdown. This is fine as we are about to restore the snapshot.)
+
image::module-02/11_VM_Stopped_Snapshot.png[link=self, window=blank, width=100%] 
+
. Navigate back to the *Snapshots* tab, click the three-dot menu, and with the VM stopped, you will find *Restore* is no longer greyed out. Click it.
+
image::module-02/12_VM_Restore.png[link=self, window=blank, width=100%]
+
. In the dialog shown, press *Restore*.
+
image::module-02/13_VM_Restore_Dialog.png[link=self, window=blank, width=100%]

. Wait until the VM is restored, the process should be fairly quick.
+
image::module-02/14_VM_Restored.png[link=self, window=blank, width=100%]
+
. Return to *Overview* tab, and start the VM.
+
image::module-02/15_VM_Start.png[link=self, window=blank, width=100%]
+
. Click on the console tab to confirm that the VM has now restarted successfully. 
+
image::module-02/16_VM_Running.png[link=self, window=blank, width=100%]

[[clone_vm]]
== Clone a Virtual Machine

Cloning creates a new VM that uses it's own disk image for storage, but most of the clone's configuration and stored data is identical to the source VM.

. Return to the *Overview* screen, and click the *Actions* dropdown menu to see the option to clone the VM.
+
image::module-02/17_Overview_Actions_Clone.png[link=self, window=blank, width=100%]
. Press *Clone* from the *Actions* menu, and a dialog will open. Name the cloned VM *fedora02*, and select the check box to *Start VirtualMachine on clone*.
+
image::module-02/18_VM_Clone_Dialog.png[link=self, window=blank, width=100%]
+
. A new VM is created, the disks are cloned and automatically the portal will redirect you to the new VM, and you can see the *Created* time as very recently.
+
image::module-02/19_VM_Cloned.png[link=self, window=blank, width=100%]
+
[IMPORTANT]
The cloned VM will have the same identity as the source VM, which may cause conflicts with applications and other clients interacting with the VM. Use caution when cloning a VM connected to an external network or in the same project.

== Summary

In this section of our lab we explored the storage options that are available to us when managing virtual machines. We also performed several VM management functions that are dependant on the storage provisioned for the virtual machine, including taking snapshots of VMs and cloning VMs to be used in another project or to help streamline development.
